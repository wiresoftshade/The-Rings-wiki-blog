8 декабря 2024 г.

# Опишу работу World Constructor. Система при помощи которой строится окружение вокруг планеты газового гиганта

Начинается все с интерфейса, куда игрок вводит параметры системы. То гравитация планеты с большой массой, количество спутников, количество колец и их свойства. Свойства колец в виде указания баланса между типами вещества в них. Льда и силикатов. А так же степени их минерализации. Указываются станции на орбитах.

С точки зрения структуры системы. Есть `BP_GameInstance`, он создает менеджер экторов `BP_ActorManager`. Функция менеджера регистрировать, хранить и выдавать списки всех экторов созданной сцены. Далее `BP_GameModeBase` определяет будет ли строиться сцена по флагу `bCreateScene`. По команде гейммода запускается создание сцены в BP_GameInstance. Он запускает создание основной планеты с большой массой, спутников, колец и станций. Передает эти экторы менеджеру для регистрации в нем. Так мы всегда можем получить доступ к основной планете, зная, что она основная и к ее спутникам. Так же к каждому из колец и станций на орбитах.

## Какие объекты включает в себя система

### **World Settings widget**

Настраиваются параметры:
- Moon bodies
    - ползунок. количество лун. он создаст примерно порядка 10, 20, 30. Но сколько точно вы не знаете.
- Big Mass body
    - ползунок. гравитационная постоянная тела. это по сути сила гравитации. А определит она в итоге скорость игры.
    - выбрать тип тела.
- Ring map settings
    - список колец. можно добавить или удалить. при добавлении создаются. рандомные параметры кольца.
    - ползунок. пустое расстояние между этим и соседним.
    - ползунок. ширина кольца.
    - ползунок. минерализация в процентах.
    - ползунок. Содержание в виде баланса между льдом и силикатами.
- Orbit Stations
    - Список спутников. можно добавить и удалить.
    - параметры орбиты в виде расстояния. должны проходить только между кольцами, внутри или снаружи колец.

### **Game Instance**

- `EventInit` создает Actor Manager и сетапит его, Создает Generator. 
- `StartWorld` запускает пустой уровень.
- `EventCreateScene` Создает сцену, а именно:
- `SpawnBigMassBody` создает главную планету с большой массой (флаг `King`).
- `SpawnBodies`  создает спутники этой планеты.
- `SpawnRings` создает кольца.
- создает космические станции.
- `SpawnEnvironment` создает свет звезды, свет окружения, создает окружение звезд.

### **Generator**
- создает шаблоны полей астероидов для использования в кластерах.
- запускается по запросу `Ring`.

### **Actor Manager**
- `Registrate`: регистрирует каждый эктор, чтобы предоставлять их другим системам по запросу.
    - спутники (`SpaceBodies`, `Moons`).
    - кольца (`Ring` and `FarRing`).
    - главную планету `BigMassBody`.
    - корабль игрока, и другие станции.
    - экторы освещения и окружения `SpaceLight`, `SpaceEnvironment`.
- `StartRings` инициирует запуск систем построения колец.
- `StartSpaceBody` инициирует запуск систем космических тел.
- `StartShip` инициирует запуск систем корабля игрока.
- `StartCelestial` инициирует запуск систем космических станций.
- `ReceiveData` *выдает какие либо данные (общего вида функция)*.
- `GetStarLight`  выдает DirectLightComponent старлайта.
- `GetSpaceLight` выдает спйслайт `BP_SpaceLight`.
- `GetSpaceEnvironment` выдает спейс окружение `BP_StarfieldSpaceSphere`.

### **Function Libraty Visual** (`FL_Visual`)
- `GetBPGameInstance` - выдает наш класс гейминстанса.
- `GetActorManager` - выдает эктор менеджер.

### **Function Libraty Math** (`FL_Math`)
- `DecartToPolarYaw` декартову в полярную, но используется анриловский Yaw вместо Angle для удобства задавать Rotation.
- `PolarYawToDecart` полярную с Yaw вместо Angle в декартову.

### Несколько **Game modes**. 

*в действительности не важно сколько. главное, что гейммод решает использовать построение мира, либо просто загрузить уровень.*

### **SpaceLight**
- освещает сцену директлайтом и скайлайтом.

### **Starfield Space Sphere**
- `ConstructionScript` создает сферу с текстурой, создает изображения звезд, создает изображение звезды системы, *которая светит на сцену при помощи `SpaceLight`*.

### **Ring**
- определяет место видимости кольца камерой и создает там `Clusters`
- `SetupRing` установки переменных (сетап).
    - `SetupGrid` основные параметры для формирования сетки(`clusters list`) треков и кластеров.
        - `Solve Visibility by Height Cash` кэш видимых кластеров.
        - `SetTrackProperty` задает проперти для каждого трэка. здесь должна определяться карта/градиент всех пропертей одного трэка.
- `UpdateClusters` Основная задача: обновление кластеров запускается после построения сетки один раз и далее запускается по таймеру с UpdateTime решает по двум бранчам с условиями.
    - `Update Visible Area` Это нужно чтоб записать только позицию на треке. 
    для определения первого и последнего индекса трека, а так же чтобы разрешить или запретить обновление.
    - `UpdateGrid` создание или обновление сетки. запускается при обновлении кластеров. цель: создать список видимых кластеров.
        - `GridTrackDistance` определить первый и последний видимый индекс сетки. разрешить или запретить обновление сетки.
        - `GridClusterDistance` определить первый и последний видимый кластер-индекс сетки.
    - `CreateClustersData` Clusters: Удаляем, создаем. Использует `clusters list`. Если создаем, то пишем Данные в словарь(`TrucksAndClusters`). Если удаляем - стираем.
        - `DeleteCluster` Записывает в словарь, что он был убит и уничтожает эктора.
        - `The Cluster Is Nearby` Она решает близко ли кластер к пешке. Чтобы решить нужен он или не нужен. Она больше не понадобится, если чище сделать составление списка видимых. Так надо и сделать. Там есть хороший метод создания кеша(`Solve Visibility by Height Cash`).
        - `WriteTrack` Записывает в словарь пустую запись о треке. 
        - `Spawn Cluster if not Exist` Coздает кластер если он ранее не был создан. Генерирующие, в свою очередь, поле камней инстансами.
        - `WriteClusterData` Берет указанный трек в словаре и добавляет ему запись о заданном кластере. И записывает в словарь дату этого кластера.

### **FarRing**
- `ConstructionScript` изображает цвет, результирующая плотность(!( плотность * толщину )!), материал. Словом материал его передает все настраиваемые свойства колец в виде дального плана.
- анимация кругового движения.

### **Cluster**
- генерирует кластер поля камней разного вида, плотности, состава. Инстанс меши.
    - `SetupRingField` сетап параметров, запуск расчетов.
    - `Solve` расчет геометрических параметров поля для расстановки инстансов.
    - `AddSomeInstances` генерирует инстансы, размазывая по времени, чтобы не грузить систему. Параметр `NumSomeInstances`.
        - `Make Transform Random On Area` для каждого из инстансов.
- `SetupAsteroidVisual` изображает лед или камень, различные модели камней, различные размеры камней, различная толщина кольца, 
- анимация кругового движения.
- при приближении корабля заменяет инстансы на физические меш-экторы. - отправляет ему данные для визуализации `Setup Asteroid Visual`.
- при отдалении заменяет физический на инстанс. 
- `OnReplace` может принять физические параметры при замене физического эктора на инстанс.

### **Asteroid**
- `SetupVisual` имеет static mesh, его материал показывает камень это или лед.
- на его поверхности изображены минералы, если имеются.
- сталкивается с кораблем и другими.
- `EventDispatcher` `OnReplace` может отдать физические параметры при замене физического эктора на инстанс.
- `OrbitMotion component` орбитальный полет.

## Что не сделано

Не сделана умная система обнаружения видимости кластеров. Прогнозирование движения и поворота камеры. Там есть код в процессе. 

### Объекты:

- Game Instance
    - не создает космические станции.
- Actor Manager
    - не регистрирует корабль игрока, и другие станции.
- Generator
    - не создает шаблоны полей астероидов для использования в кластерах.
    - не запускается по запросу `Ring`.
- Ring
    - `SetTrackProperty` не задает проперти для каждого трэка. не определяться карта/градиент всех пропертей одного трэка. 
    Сейчас это `Set Property Density` пока только плотность.
    - не использует `Generator` object, не передает эти данные кластерам. Вместо этого генерацией занимается каждый кластер, что плохо для производительности.
- FarRing
    - сейчас материал его не передает все настраиваемые свойства колец в виде дального плана. его вид очень примерный и не подчиняется данным, настроенным игроком.
- Asteroid
    - нет поддержки разных static mesh. 
    - нет поддержки скаттеринга мелкой крошки и пыли на поверхности.
    - его материал не показывает камень это или лед.
    - на его поверхности не изображены минералы, если имеются.

## Какие остались проблемы

1. Не отработана передача и реализация всех параметров колец. Нужны новые структуры.

2. Нет генерации этих параметров по текстуре, чтобы кольца имели красивый структурный вид по концепту. Это материалы, состав, количество вещества. Это про вид `FarRing`.

3. не решено какие данные надо передать кольцу, кластеру, астероиду. Нужно разделить эти потоки. Нужны структуры типа `S_RingProperty`, `S_ClusterProperty`, `S_AsteroidProperty` 

3. не понятно как формировать материал астероида.

4. Не настроена возможность создать кольца в варианте фиксированном. Система может такое но в конструкторе нет режима предварительной заготовки колец. Есть только рандомная. 

5. Так же нет возможности сделать просто лишь дальний вид без генерации. Для превью, например. Причем есть в системе отдельно эктор кольца для дальнего плана `FarRing`. 

6. Виджет не умеет удалять кольцо из списка. Иными словами кнопка `-` *minus* не работает.