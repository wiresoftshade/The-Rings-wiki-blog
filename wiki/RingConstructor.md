# Ring Constructor. Система построения колец. И их различные уровни детализации

Свойства колец в виде указания баланса между типами вещества в них. Льда и силикатов. А так же степени их минерализации. Оптические свойства для изображения дальних видов.

## Какие объекты включает в себя система

### Структуры и дата ассеты

#### Структуры

Решено делать 2 вида данных: Первые(`S_RingProperty`) используются в генераторе мира. Вторые(`S_Cluster`, `S_Track`, `S_Ring`) являются разметкой и размерностями. Передаются в каждый Ring, Cluster, Asteroid.

- `S_RingProperty` - Содержит текстуры с данными настройки материала. Данные состава. Управляющий флаг `bSpawnableAsteroids` для дебагинга. Набор старый, нужно удалить лишнее, вставить актуальное.
- `S_OpticProperties` - набор оптических свойств для рендера объемным шейдером. 
- `S_Track` - Содержит массив `S_Cluster`. Служит для записи журнала состояний при генерации в переменную `TracksAndClusters`. Еще использ. в HUD для дебагинга
- `S_ClusterProperty` - Для кластера данные о разметке текстур, размерности, свойства плотности, состава, номер трэка в котором этот кластер. `Ring` дает эти данные кластеру `On SetupRingField`. `Cluster` в этом эвенте записывает себе в переменные эти данные. Делает расчет `Solve`. 
- `S_Cluster` - это так называемый журнал состояний кластеров в системе генераций. Ссылка на эктора, Состояние создан или убит, bbound, origin. Многие его параметры устарели. 
- `S_AsteroidProperty` - там задаются для каждого отдельного астероида его варианты мешек на выбор, материалы на выбор, рандом масштаба, рандом поворота, состав веществ(минералы, лед, силикаты). Сюда дублируются эти данные из кластеров, чтобы каждый мог генерировать отдельно свой вид.
- `S_BackAsteroidPhysics` - Это данные которые астероид вернет кластеру, когда будет удален. Transform, Velocity, AngularVelocity

#### Типы дата ассетов. Типы сеттингов

- `PDA_Ring` - определить уникальные свойства каждого кольца. Что в них есть а чего нет. 
- `PDA_AsteroidField` - Чтобы определить типы инстанс мешек. Есть список типов единичных Астероидов. Определять их состав, а по итогу вид материала. И чтобы определить типы объемных шейдеров полей по оптическим свойствам. *Определить профиль толщины поля(пока не будет поддержаваться).*  
- `PDA_SingleAsteroid` - определить построение единичных моделей астероидов, которые взаимодействуют с кораблем. Чтобы он имел все данные свойств из поля астероидов (`AsteroidField`), которому он пренадлежит.

#### Дата ассеты. Сеттинги

Поля должны быть либо богатые на все подряд, либо силикатные, либо ледяные:
- `DA_Ring_Mix` - Кольцо, включающее в себя все типы полей. 
- `DA_Ring_Silicates` - Кольцо только с типом поля Силикаты.
- `DA_Ring_Ice` - Кольцо только с типом поля Льды.
- `DA_Field_Crystals` - Пока не заготовлена, но там будут меши, напоминающие кристалы. И они должны отображать только минеральную или ледяную составляющую.
- `DA_Field_Ice` - поле отображающее ледяную составляющую. Изображает долю минералов.
- `DA_Field_Silicates` - поле отображающее силикатную составляющую. Изображает долю минералов.
- `DA_Asteroid_Crystals` - Астероиды в форме кристаликов.
- `DA_Asteroid_Legacy` - настройка астероида какой он был до момента создания этих настроек
- `DA_Asteroid_Meteors` - Одина из форм из папки Art/Space/Meteors

### **Game Instance Generator / Creator**

Это набор функций Game Instance Object, которые занимаются генерацией объектов мира. 
- создает шаблоны полей астероидов для использования в кластерах. 
    - запускается по запросу `Ring`.

### **Actor Manager**
- `GetStarLight`  выдает DirectLightComponent светильника звезды. Требуется для передачи направления света в шейдеры колец. + другие параметры света.

### **Function Libraty Math** (`FL_Math`)
- `DecartToPolarYaw` декартову в полярную, но используется анриловский Yaw вместо Angle для удобства задавать Rotation.
- `PolarYawToDecart` полярную с Yaw вместо Angle в декартову.

### **Ring**
- определяет место видимости кольца камерой и создает там `Clusters`
- `SetupRing` установки переменных (сетап).
    - `SetupGrid` основные параметры для формирования сетки(`clusters list`) треков и кластеров.
        - `Solve Visibility by Height Cash` кэш видимых кластеров.
        - `SetTrackProperty` задает проперти для каждого трэка. здесь должна определяться карта/градиент всех пропертей одного трэка.
- `UpdateClusters` Основная задача: обновление кластеров запускается после построения сетки один раз и далее запускается по таймеру с UpdateTime решает по двум бранчам с условиями.
    - `Update Visible Area` Это нужно чтоб записать только позицию на треке. 
    для определения первого и последнего индекса трека, а так же чтобы разрешить или запретить обновление.
    - `UpdateGrid` создание или обновление сетки. запускается при обновлении кластеров. цель: создать список видимых кластеров.
        - `GridTrackDistance` определить первый и последний видимый индекс сетки. разрешить или запретить обновление сетки.
        - `GridClusterDistance` определить первый и последний видимый кластер-индекс сетки.
    - `CreateClustersData` Clusters: Удаляем, создаем. Использует `clusters list`. Если создаем, то пишем Данные в словарь(`TrucksAndClusters`). Если удаляем - стираем.
        - `DeleteCluster` Записывает в словарь, что он был убит и уничтожает эктора.
        - `The Cluster Is Nearby` Она решает близко ли кластер к пешке. Чтобы решить нужен он или не нужен. Она больше не понадобится, если чище сделать составление списка видимых. Так надо и сделать. Там есть хороший метод создания кеша(`Solve Visibility by Height Cash`).
        - `WriteTrack` Записывает в словарь пустую запись о треке. 
        - `Spawn Cluster if not Exist` Coздает кластер если он ранее не был создан. Генерирующие, в свою очередь, поле камней инстансами.
        - `WriteClusterData` Берет указанный трек в словаре и добавляет ему запись о заданном кластере. И записывает в словарь дату этого кластера.

### **FarRing**
- `ConstructionScript` изображает цвет, результирующая плотность(!( плотность * толщину )!), материал. Словом материал его передает все настраиваемые свойства колец в виде дального плана.
- `Setup` передает данные о кольце (`RingProperty`), запускает вращение, делает обновления динамик материала на основе полученных данных о кольце из `RingProperty`
- анимация кругового движения.

### **Cluster**
- генерирует кластер поля камней разного вида, плотности, состава. Инстанс меши.
    - `SetupRingField` сетап параметров, запуск расчетов.
    - `Solve` расчет геометрических параметров поля для расстановки инстансов.
    - `AddSomeInstances` генерирует инстансы, размазывая по времени, чтобы не грузить систему. Параметр `NumSomeInstances`.
        - `Make Transform Random On Area` для каждого из инстансов.
- `SetupAsteroidVisual` изображает лед или камень, различные модели камней, различные размеры камней, различная толщина кольца, 
- при приближении корабля заменяет инстансы на физические меш-экторы. - отправляет ему данные для визуализации `Setup Asteroid Visual`.
- при отдалении заменяет физический на инстанс. 
- `OnReplace` может принять физические параметры при замене физического эктора на инстанс.
- анимация кругового движения.

### **Asteroid**
- `SetupVisual` имеет static mesh, его материал показывает камень это или лед.
- на его поверхности изображены минералы, если имеются.
- сталкивается с кораблем и другими.
- `EventDispatcher` `OnReplace` может отдать физические параметры при замене физического эктора на инстанс.
- `OrbitMotion component` орбитальный полет.

## Что не сделано

### Объекты:

- Game Instance (Generator)
    - не создает шаблоны полей астероидов для использования в кластерах.
    - не запускается по запросу `Ring`.
- Ring
    - `SetTrackProperty` не задает проперти для каждого трэка. не определяться карта/градиент всех пропертей одного трэка. 
    Сейчас это `Set Property Density` пока только плотность.
    - не использует `Generator`, не передает эти данные кластерам. Вместо этого генерацией занимается каждый кластер, что плохо для производительности.
- FarRing
    - сейчас материал его не передает все настраиваемые свойства колец в виде дального плана. Сейчс его вид примерный и не подчиняется данным, настроенным игроком в меню. Не видно лед/не лед, плотность просто из легаси текстуры в материале. минерализация тоже не отображается.
- Cluster
    **!!** Не сделана умная система обнаружения видимости кластеров. Прогнозирование движения и поворота камеры. Там есть код в процессе. 
- Asteroid
    - ~~нет~~ поддержки разных static mesh. (пресеты DA_ содержат это) 
    - нет поддержки скаттеринга мелкой крошки и пыли на поверхности.
    - его материал не показывает камень это или лед.
    - на его поверхности не изображены минералы, если имеются.

## Какие остались проблемы

2. Нет генерации параметров (плотность, состав минералов, баланс льда, оптические свойства) по текстуре, чтобы кольца имели красивый структурный вид по концепту. Это материалы, состав, количество вещества. Это про вид `FarRing`.
Связана с 3.2 см Генератор мира.

3. Созданы структуры: `S_RingProperty`, `S_ClusterProperty`, `S_AsteroidProperty`. 

    3.0 `S_RingProperty` - Набор старый, нужно удалить лишнее, вставить актуальное.

8. ~~Нет~~ Есть дата ассеты для установок параметров колец, чтобы было удобно управлять. Там есть Ring, Field, Asteroid типы датаассетов. *Сделав это, наверное, придет понимание что я хочу и в каком объеме.* 
Связана с 3.2 см Генератор мира.

10. Кластеры занимаются лишней работой. Они расчитывают штуки, которые могут быть посчитаны в Ring. Мало того кластеры одинаковые везде и могут быть расчитаны в GameInstance. 
Связана с 3.2 см Генератор мира.